name: Submit to NVDA Add-on Store

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  submit:
    # Only submit stable releases, not nightly pre-releases
    if: "!github.event.release.prerelease"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Extract addon metadata from buildVars.py
        id: meta
        run: |
          python3 -c "
          import buildVars
          info = buildVars.addon_info
          print(f'addon_name={info[\"addon_name\"]}')
          print(f'addon_version={info[\"addon_version\"]}')
          print(f'publisher={info[\"addon_author\"]}')
          print(f'homepage={info[\"addon_url\"]}')
          " >> $GITHUB_OUTPUT

      - name: Identify addon asset download URL
        id: asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"

          # Get the browser download URL (not the API URL)
          DOWNLOAD_URL=$(gh release view "$TAG" --json assets \
            --jq '.assets[] | select(.name | endswith(".nvda-addon")) | .url')

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "::error::No .nvda-addon asset found in release $TAG"
            exit 1
          fi

          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "Download URL: $DOWNLOAD_URL"

      - name: Validate download URL
        run: |
          URL="${{ steps.asset.outputs.download_url }}"

          if [[ "$URL" != https* ]]; then
            echo "::error::Download URL must start with https"
            exit 1
          fi

          if [[ "$URL" != *.nvda-addon ]]; then
            echo "::error::Download URL must end with .nvda-addon"
            exit 1
          fi

          HTTP_CODE=$(curl -fSL -o /dev/null -w "%{http_code}" "$URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Download URL returned HTTP $HTTP_CODE"
            exit 1
          fi

          echo "Download URL validated successfully"

      - name: Submit to NVDA Add-on Store
        env:
          GH_TOKEN: ${{ secrets.NVDA_STORE_TOKEN }}
        run: |
          DOWNLOAD_URL="${{ steps.asset.outputs.download_url }}"
          SOURCE_URL="${{ steps.meta.outputs.homepage }}"
          PUBLISHER="${{ steps.meta.outputs.publisher }}"
          ADDON_NAME="${{ steps.meta.outputs.addon_name }}"
          VERSION="${{ steps.meta.outputs.addon_version }}"

          echo "=== Submission Summary ==="
          echo "Add-on:    $ADDON_NAME v$VERSION"
          echo "Publisher: $PUBLISHER"
          echo "Channel:   beta"
          echo "Download:  $DOWNLOAD_URL"
          echo "Source:    $SOURCE_URL"
          echo "License:   GPL v3"
          echo "=========================="

          # Build the issue body file matching the exact markdown format
          # produced by the nvaccess/addon-datastore registerAddon.yml
          # issue form so their automation recognises it.
          cat > /tmp/issue_body.md <<EOF
### Download URL

${DOWNLOAD_URL}

### Source URL

${SOURCE_URL}

### Publisher

${PUBLISHER}

### Channel

beta

### License Name

GPL v3

### License URL

https://www.gnu.org/licenses/gpl-3.0.html
EOF

          gh issue create \
            --repo "nvaccess/addon-datastore" \
            --title "[Submit add-on]: ${ADDON_NAME} v${VERSION}" \
            --body-file /tmp/issue_body.md

          echo "Submission issue created successfully."
